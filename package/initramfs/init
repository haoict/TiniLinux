#!/bin/sh

#####
#
# /init for BusyBox initramfs -> real root
#
#####
echo "[initramfs] Booting..."

# Mount pseudo filesystems
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -t devtmpfs dev /dev
mount -t tmpfs tmpfs /run

# Parse kernel command line
for param in $(cat /proc/cmdline); do
    case $param in
        root=*)
            root="${param#root=}"
            ;;
        init=*)
            init="${param#init=}"
            ;;
        overlayfs=*)
            overlayfs="${param#overlayfs=}"
            ;;
        squashfspart=*)
            squashfspart="${param#squashfspart=}"
            ;;
        squashfsroot=*)
            squashfsroot="${param#squashfsroot=}"
            ;;
    esac
done

mkdir -p /newroot

# if overlayfs is specified, set up OverlayFS
if [ -n "$overlayfs" ] && [ -n "$squashfspart" ] && [ -n "$squashfsroot" ]; then
    echo "[initramfs] Setting up OverlayFS: lower from $squashfspart/$squashfsroot, upper on $overlayfs"
    mkdir -p /mnt/boot /mnt/lower /mnt/rw
    mount -o ro "$squashfspart" /mnt/boot || exec sh
    mount -t squashfs -o loop,ro "/mnt/boot/$squashfsroot" /mnt/lower || exec sh
    mount -o rw "$overlayfs" /mnt/rw || exec sh
    mkdir -p /mnt/rw/upper
    mkdir -p /mnt/rw/work
    mount -t overlay overlay -o lowerdir=/mnt/lower,upperdir=/mnt/rw/upper,workdir=/mnt/rw/work /newroot || exec sh
    mount --move /mnt/boot /newroot/boot
else
    echo "[initramfs] No OverlayFS specified, using root=$root directly."
    mount -o rw "$root" /newroot || exec sh
fi

# Mount runtime dirs for systemd
mount --move /proc /newroot/proc
mount --move /sys /newroot/sys
mount --move /dev /newroot/dev
mount --move /run /newroot/run

echo "[initramfs] Switching to real root..."
exec switch_root /newroot ${init:-/sbin/init}
